---
title: "Tests of `flexdashboard` functionalities"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: 
      version: 4
      bootswatch: litera
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, echo = F}

# knitr::opts_chunk$set(echo = F)
# Sys.setlocale("LC_TIME", "English") # language = English, does not work right now

# fundamentals
library(flexdashboard)
library(etn)
library(knitr)
library(shiny)

# data wrangling
library(readr)
library(tidyverse)
library(lubridate)
library(dplyr)
library(lubridate)
library(utils)
library(tidyverse)

# maps
library(leaflet)
library(leafem)

# plotting and tables
library(DT) # for interactive tables
library(ggplot2)
library(kableExtra)
library(plotly)
library(scico) #colour palettes
library(gridExtra)
library(ggridges)


```


```{r database query, include=FALSE, echo=FALSE}

path_animals <- paste0(getwd(), "/data/Squalus_acanthias_animals.csv")
animals <- utils::read.table(file = path_animals, 
                            header = T,
                            sep = ",")

```



Twaite Shads
=====================================


Column {data-width=1000 .tabset}
-------------------------------------

### Acoustic receivers

```{r doublecols jira}

# libraries
library(etn)
library(dplyr)
library(tidyverse)

# database connection
con <- etn::connect_to_etn(Sys.getenv("userid"), Sys.getenv("pwd"))

# get ETN animals
M_asterias <- etn::get_animals(scientific_name = "Mustelus asterias")
G_morhua <- etn::get_animals(scientific_name = "Gadus morhua")
G_morhua_projects <- etn::get_animals(animal_project_code = c("rijke_noordzee", "PC4C", "2015_PHD_verhelst_cod", "2010_PHD_Reubens", "codnoise"))

# Why are there more cod in the df with specified projects than in the one where (I thought) tagged from all projects are retrieved?
G_morhua %>% nrow()
G_morhua_projects %>% nrow()


# inspect animal dfs
M_asterias %>% 
  dplyr::select(tag_serial_number:acoustic_tag_id) %>%
  head() %>% 
  View()
# For M. asterias, the selected columns have double entries

G_morhua %>% 
  dplyr::select(tag_serial_number:acoustic_tag_id) %>%
  head() %>% 
  View()
# For 

G_morhua_projects %>% 
  dplyr::select(tag_serial_number:acoustic_tag_id) %>%
  head() %>% 
  View()

```


```{r map}


leaflet() %>%
  addTiles()

```

<!-- > Map with receiver deployments and acoustic detections. -->


### Questions

* Is it correct that receiver stations well into the Schelde apparently detected S. acanthias

* Are the animals really equipped with tags that last for 6 years (i.e., being detected between 2016 and 2022)?

> I suspect that the detections from ~2018/19 onwards are fake detections...What do you say?


### Improvements

* mark sex in abacus plot (either by colouring the y axis label or by inserting a symbol that maps sex at the tagging date)

* map # detections onto the stations on the acoustic receiver map


<!-- ### {data-height=150} -->

<!-- ```{r valueBoxes} -->

<!-- valueBox(animals %>% nrow(),  -->

<!--          caption = '# animals tagged',  -->

<!--          icon = 'fa-fish-fins' -->

<!--          # ,href = '#trip-duration' -->

<!-- ) -->


<!-- valueBox(100,  -->

<!--          caption = 'test',  -->

<!--          icon = 'fa-fish-fins' -->

<!--          # ,href = '#trip-duration' -->

<!-- ) -->
<!-- ``` -->


<!-- Column {data-width=650} -->
<!-- -------------------------------------    -->

    
### Acoustic detections
    

```{r table}

# make table
table_animals <- 
  DT::datatable(animals %>% 
                  dplyr::select(idPk, utcReleaseDateTime, sex, tag, releaseLatitude, releaseLongitude) %>%
                  dplyr::rename(animal_id = idPk, release_date_time = utcReleaseDateTime,  release_latitude = releaseLatitude, release_longitude = releaseLongitude), #release_location = tagging_location,
              rownames = F,
              filter = 'bottom',
              extension = 'Buttons',options = list(
                dom = 'Bfrtip',
                buttons = c('pdf', 'csv', 'excel', 'print','copy'),
                columnDefs = list(list(className = 'dt-center', targets = '_all'))
              )
            ) %>%
  formatStyle(
  c('animal_id', 'sex'),
  fontWeight = "bold") %>%
  formatStyle(
  'sex',
  backgroundColor = styleEqual(c("F", "M"), c('#FFBB81', '#89B6BD')))



shiny::tabsetPanel(
  tabPanel("Info about tagged animals",
           table_animals),
  tabPanel("Latitudinal distribution",
           "hello world"
           )
)


```

Page 2 {data-navmenu="Mackerel"}
=====================================


Column {data-width=1000 .tabset}
-------------------------------------

### Acoustic receivers

```{r map2}


leaflet() %>%
  addTiles()

```

### more info

* test

* test
