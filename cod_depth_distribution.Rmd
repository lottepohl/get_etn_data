---
title: "Cod depth distribution"
subtitle: "diurnal patterns, class I, II and above"
output:
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    theme: 
      version: 4
      bootswatch: litera
editor_options: 
  chunk_output_type: console
---

<!-- --- -->
<!-- title: "Cod depth distribution" -->
<!-- subtitle: "diurnal patterns, class I, II and above" -->
<!-- output: html_document -->
<!-- editor_options:  -->
<!--   chunk_output_type: console -->
<!-- --- -->


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Libraries 
library(flexdashboard)
library(shiny)
# library(devtools)
# devtools::install_github("inbo/etn")
# devtools::install_github("lifewatch/mregions2")
library(etn)
library(dplyr)
library(lubridate)
library(utils)
library(leaflet)
# library(tidyverse)
library(knitr)
library(kableExtra)
library(leafem)
library(leaflet.extras)
library(mregions2)
library(plotly)
library(DT) # for interactive tables
library(scico)

# database connection

# con <- etn::connect_to_etn(Sys.getenv("userid"), Sys.getenv("pwd"))

# FUNCTIONS
# function to clean ETN tables
remove_double_cols <- function(animals){
  animals$tag_serial_number <- gsub(",.*","", animals$tag_serial_number)
  animals$tag_type <- gsub(",.*","", animals$tag_type)
  animals$tag_subtype <- gsub(",.*","", animals$tag_subtype)
  animals$acoustic_tag_id <- gsub(",.*","", animals$acoustic_tag_id)
  return(animals)
}

# save data as.rds ####
# folder needs to have a '/' as last character

save_data <- function(data, folder){
  base::saveRDS(data, file = paste0(folder, deparse(substitute(data)), ".rds"))
}

# load rds data ####

load_data <- function(filestring, folder){
  data <- base::readRDS(file = paste0(folder, filestring, ".rds"))
  return(data)
}

```

```{r dataquery, include=F, echo=F}

# PROJECTS
project_codes <- c("rijke_noordzee", "PC4C", "2015_PHD_verhelst_cod", "2010_PHD_Reubens", "codnoise")

#For now: no direct query through the ETN database but load data in folder ./data/data_cod_janr

# ANIMALS
# animals_cod <- etn::get_animals(animal_project_code = project_codes) %>%
#   remove_double_cols()
# save_data(animals_cod, folder = paste0(getwd(), "/data/data_cod_janr/"))
animals_cod <- load_data("animals_cod", folder = paste0(getwd(), "/data/data_cod_janr/"))

# TAG INFORMATION
# tags_cod <- etn::get_tags(acoustic_tag_id = animals_cod$acoustic_tag_id)
# save_data(tags_cod, folder = paste0(getwd(), "/data/data_cod_janr/"))
tags_relevant_cols <- c("tag_serial_number", "sensor_type", "manufacturer", "model", "frequency", "status", "battery_estimated_life", "activation_date", "battery_estimated_end_date", "sensor_slope", "sensor_intercept", "sensor_range", "sensor_unit", "sensor_transmit_ratio", "accelerometer_algorithm", "sensor_transmit_ratio", "owner_pi", "step1_min_delay", "step1_max_delay", "step1_duration", "step1_acceleration_duration")
# "acoustic_tag_id", "tag_type", "acoustic_tag_id_alternative",
tags_cod <- load_data("tags_cod", folder = paste0(getwd(), "/data/data_cod_janr/"))

# only keep the animals for which we have depth sensor information
animals_cod_depth <- animals_cod %>%
  dplyr::left_join(tags_cod %>% 
                     dplyr::select(all_of(tags_relevant_cols)),
                   by = "tag_serial_number") %>%
  dplyr::filter(sensor_type %in% c("P", "pressure")) %>% # only retain sensor types "P"/"pressure"
  dplyr::filter(length1 > 19.9) %>% #separate into age classes, from Reubens et al., 2013 (Mar. Env. Res.)
  dplyr::mutate(age_group = ifelse(length1 < 43.3, 1, 
                                   ifelse(length1 < 54.6, 2, 
                                          ifelse(length1 < 61.2, 3,
                                                 4))) %>%
                  factor(levels = c(1, 2, 3, 4)),
                age_group_name = ifelse(age_group == 1, "1-group",
                                        ifelse(age_group == 2, "2-group",
                                               ifelse(age_group == 3, "3-group", "> 3-group")))) # age class 4 is categorized as all cod longer than 61.2 cm


# making sure there really are no cods in group III
# animals_cod_depth %>% 
#   dplyr::filter(length1 %>% between(54.6, 61.2)) %>% 
#   View()

# animals_cod_depth$sensor_type %>% unique()
# animals_cod_depth$animal_project_code %>% unique()

#both are 60
# animals_cod_depth$acoustic_tag_id %>% unique() %>% length() 
# animals_cod_depth$tag_serial_number %>% unique() %>% length()

# DETECTIONS
# detections_cod <- etn::get_acoustic_detections(
#   acoustic_tag_id = animals_cod_depth$acoustic_tag_id %>% unique())
# 
# save_data(detections_cod, folder = paste0(getwd(), "/data/data_cod_janr/"))
detections_cod <- load_data("detections_cod", folder = paste0(getwd(), "/data/data_cod_janr/"))

# detections_cod$tag_serial_number %>% unique() %>% length()
# detections_cod$date_time %>% min()
# detections_cod$date_time %>% max()

```


```{r depthCalc, include=F, echo=F}

detections_cod_depth <- detections_cod %>%
  left_join(animals_cod_depth %>% 
              dplyr::select(tag_serial_number, sensor_slope, sensor_intercept, age_group, age_group_name),
            by = join_by(tag_serial_number)) %>%
  dplyr::mutate(depth_m = (sensor_value * sensor_slope) + sensor_intercept) %>% #calc depth
  dplyr::filter(depth_m > 0) %>% #filter out weird depths(i.e., depths < 0)
  # some stats
  dplyr::mutate(hour_of_day = lubridate::hour(date_time) %>% as.factor(),
                year = lubridate::year(date_time),
                month = lubridate::month(date_time, label = T, abbr = T),
                month_count = lubridate::month(date_time, label = F),
                monthyear = paste0(month, "-", year),
                month_date = paste0(year, "-", month_count,"-", "28") %>% as.POSIXct(tz = "utc"),
                day_of_year = lubridate::yday(date_time),
                quarter = lubridate::quarter(date_time, with_year = F),
                quarter_year = lubridate::quarter(date_time, with_year = T),
                depth_bin = cut(depth_m, breaks = seq(0,40, by = 5))) %>%
  dplyr::filter(deploy_latitude > 50)
  
# rm(detections_cod)
# detections_cod_depth %>% head() %>% View()

detections_cod_depth_month <- detections_cod_depth %>%
  dplyr::group_by(monthyear, tag_serial_number, acoustic_project_code) %>%
  dplyr::summarise(n_detections = n(),
                   month_date = month_date[1],
                   age_group = age_group[1],
                   age_group_name = age_group_name[1])



```

* `r animals_cod %>% nrow()` tagged cod found for the projects codes `r project_codes`.

* `r animals_cod_depth %>% nrow()` were equipped with a depth sensor, out of which `r detections_cod$tag_serial_number %>% unique() %>% length()` were detected by acoustic receivers.

* Overall, the `r detections_cod$tag_serial_number %>% unique() %>% length()` cod were detected `r detections_cod_depth %>% nrow()` times, excluding erroneous detections.

### General Information

<!-- * `r animals_cod$acoustic_tag_id %>% unique() %>% length()` unique acoustic tag ids are in the cod data, and no NAs. To me that looks like some acoustic tag ids are double, just fyi. -->

```{r histAgeGroups}
p_hist_age_groups <- 
  ggplot(data = animals_cod_depth) +
  geom_histogram(aes(x = age_group), stat="count") + 
  labs(x = "age group", y = "number of individuals", title = "Age class distribution") +
  scale_y_continuous(expand = c(0,0)) +
  theme_bw()

p_hist_age_groups
```

<!-- > There are no individuals in age group 3, and `r animals_cod_depth%>% filter(age_group == 4) %>% nrow()` animal in group 4 (total length = `r animals_cod_depth%>% filter(age_group == 4) %>% select(length1) %>% pull()` cm). -->

<!-- ### Abacus plot of acoustic detections, per month   -->

```{r abacus, out.height = 10}

p_abacus <- ggplot(data = detections_cod_depth_month) + # %>% slice_sample(n = 1000)
  geom_point(aes(x = month_date, y = tag_serial_number, colour = acoustic_project_code, size = n_detections)) +
  scale_x_datetime(date_breaks = "6 months", date_labels = "%b'%y") +
  labs(title = "", x = "month", y = "tag serial number", colour = "predominant ac. project", size = "# detections") +
  facet_grid(age_group_name ~ ., scales = "free_y", space = "free_y") +
  theme_bw()

# p_abacus <- ggplot(data = detections_cod_depth_month) + # %>% slice_sample(n = 1000)
#   geom_point(aes(y = month_date, x = tag_serial_number, colour = acoustic_project_code, size = n_detections)) +
#   scale_y_datetime(date_breaks = "6 months", date_labels = "%b'%y") +
#   labs(title = "Abacus plot of acoustic detections, per month", x = "month", y = "tag serial number", colour = "predominant ac. project", size = "# detections") +
#   facet_grid(age_group_name ~ ., scales = "free_y", space = "free_y") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1)) 

p_abacus #%>% plotly::ggplotly()

# ggsave(filename = paste0(getwd(), "/data/data_cod_janr/abacus.png"), height = 23, width = 25, units = "cm", plot = p_abacus)
```

### Depth distribution of detections, per age group

```{r firstPlots}

p_hist_depth <- 
  ggplot(data = detections_cod_depth) +
  geom_histogram(aes(x = depth_m)) + 
  facet_wrap(~age_group_name) +
  labs(x = "depth in m", y = "number of detections", title = "") +
  scale_y_continuous(expand = c(0,0)) +
  theme_bw()

p_hist_depth

# ggsave(filename = paste0(getwd(), "/data/data_cod_janr/histogram_depth_agegroup.png"), height = 18, width = 20, units = "cm", plot = p_hist_depth)

# some of the detections have negative depth values. that cannot be. let's investigate why that is
# update: filtered out depths < 0 at detectsion_cod_depth. To make the following code work, disable the filter.

# tags_weird_depths <- 
#   tags_cod %>%
#   dplyr::filter(tag_serial_number %in% (detections_cod_depth %>% 
#                      dplyr::filter(depth_m < 0) %>%
#                      dplyr::select(tag_serial_number) %>% 
#                      unique() %>% pull()))

# tags_weird_depths %>% View()

# see which tags give depth values <0
# tags_cod %>% 
#   dplyr::filter(tag_serial_number %in% (tags_weird_depths %>% pull())) %>%
#   View()

# see what animals have sensor slope = 0
# animals_cod_depth %>% 
#   dplyr::filter(sensor_slope == 0)  %>%
#   View()

# detections_smallslope <- detections_cod_depth %>%
#            dplyr::filter(tag_serial_number %in% (tags_weird_depths %>% 
#                                                    # dplyr::filter(sensor_slope != 0) %>% 
#                                                    dplyr::select(tag_serial_number) %>% 
#                                                    pull())) %>%
#   dplyr::group_by(tag_serial_number) %>%
#   dplyr::summarise(min = depth_m %>% min(),
#                    mean = depth_m %>% mean(),
#                    max = depth_m %>% max())

# make csv file with tags that have sensor slope == 0 or almost 0
# write.csv(tags_weird_depths %>% dplyr::filter(sensor_slope == 0), 
#           file = paste0(getwd(), "/data/cod_tags_sensor_slope_0.csv"))

```

### Depths per hour of the day: Summary table

```{r depthbins}

depth_per_hour <- detections_cod_depth %>%
  dplyr::group_by(hour_of_day, age_group, quarter) %>%
  dplyr::summarise(min = depth_m %>% min() %>% round(digits = 2),
                   mean = depth_m %>% mean() %>% round(digits = 2),
                   sd = depth_m %>% sd() %>% round(digits = 2),
                   median = depth_m %>% median() %>% round(digits = 2),
                   max = depth_m %>% max() %>% round(digits = 2),
                   n_individuals = tag_serial_number %>% unique() %>% length() %>% round(digits = 2),
                   n_detections = n() %>% round(digits = 2),
                   age_group_name = age_group_name[1])

depth_per_hour_long <- depth_per_hour %>%
  tidyr::pivot_longer(cols = min:max, names_to = "summary_statistic", values_to = "value")



DT::datatable(depth_per_hour,
              rownames = F,
              filter = 'bottom',
              extension = 'Buttons',
              options = list(
                pageLength = 5,
                dom = 'Bfrtip',
                buttons = c('pdf', 'csv', 'excel', 'print','copy'),
                columnDefs = list(list(className = 'dt-center', targets = '_all'))
              )
            )

```

### Depth per hour of the day across all detections


```{r depthBoxplot}
# ALL DETECTIONS
p_box_tod <- ggplot(data = detections_cod_depth) +
  geom_boxplot(aes(x = hour_of_day, y = -depth_m)) +
  labs(title = "", x = "Hour of the day", y = "Depth in m") +
  theme_bw()
p_box_tod

# ggsave(filename = paste0(getwd(), "/data/data_cod_janr/boxplot_hour_of_day.png"), height = 15, width = 17, units = "cm", plot = p_box_tod)

```
### Depth per hour of the day, per month

```{r boxplot2}
# PER MONTH
p_box_tod_month <- ggplot(data = detections_cod_depth) +
  geom_boxplot(aes(x = hour_of_day, y = -depth_m)) +
  labs(title = "", x = "Hour of the day", y = "Depth in m") +
  facet_wrap(~month) +
  scale_x_discrete(breaks = seq(0,24, by = 4)) +
  theme_bw()
p_box_tod_month

# ggsave(filename = paste0(getwd(), "/data/data_cod_janr/boxplot_hour_of_day_month.png"), height = 18, width = 20, units = "cm", plot = p_box_tod_month)
```


### Min, Mean, Max depths

```{r minmeanmax, out.height = 10}
# PER QUARTER

quarter.labs <- c("Q1", "Q2", "Q3", "Q4")
names(quarter.labs) <- c("1", "2", "3", "4")

p_points_tod <- ggplot() +
  geom_errorbar(data = depth_per_hour, 
                aes(x = hour_of_day, 
                    ymin = -mean - sd, 
                    ymax = -mean + sd)) +
  geom_point(data = depth_per_hour_long %>%
                         dplyr::filter(summary_statistic %in% c("max", "min", "mean")),
             aes(x = hour_of_day, y = -value, colour = summary_statistic),
             size = 2) +
  labs(title = "Depth per hour of the day across all detections", x = "Hour of the day", y = "Depth in m", colour = "") +
  # facet_grid(age_group_name ~ ., scales = "free_y", space = "free_y") +
  facet_grid(quarter~age_group_name, 
             labeller = labeller(quarter = quarter.labs)) +
  scale_x_discrete(breaks = seq(0,24, by = 4)) +
  # scale_color_viridis_d(option = "magma") #+ 
  theme_bw()
p_points_tod #%>% ggplotly()

# ggsave(filename = paste0(getwd(), "/data/data_cod_janr/depth_max_min_mean.png"), height = 15, width = 17, units = "cm", plot = p_points_tod)

# p_points_tod <- ggplot(data = depth_per_hour) +
#   geom_bar(aes(x = hour_of_day, y = -mean), stat = "identity") +
#   # geom_ribbon(aes(x = hour_of_day, ymin = -max, ymax = -min)) +
#   # geom_errorbar(aes(x = hour_of_day, ymin = -mean - sd, ymax = -mean + sd)) +
#   labs(title = "Depth per hour of the day across all detections", x = "Hour of the day", y = "Depth in m") +
#   theme_bw()
# p_points_tod
# todo: geom ribon with max and min, new geom errorbar with deoth_per_hour (not the long df())


# p_smooth_tod <- ggplot(data = detections_cod_depth %>%
#                          dplyr::slice_sample(n = 1000)) +
#   geom_smooth(aes(x = hour_of_day, y = -depth_m)) +
#   labs(title = "Depth per hour of the day across all detections", x = "Hour of the day", y = "Depth in m") +
#   theme_bw()
# p_smooth_tod


```

### Spatial distribution of cod per quarter

```{r otherqueries, include=FALSE}

# EEZs
Dutch_EEZ <-  mregions2::gaz_search(5668) %>% mregions2::gaz_geometry()
BPNS <- mregions2::gaz_search(3293) %>% mregions2::gaz_geometry()
French_EEZ <- mregions2::gaz_search(5677) %>% mregions2::gaz_geometry()
UK_EEZ <- mregions2::gaz_search(5696) %>% mregions2::gaz_geometry()

EEZs <- rbind(Dutch_EEZ, BPNS, French_EEZ, UK_EEZ)

```

```{r avgDepthStation, include=FALSE}

# detections_cod_depth$station_name %>% unique() #%>% View() #length()
# detections_cod_depth %>% head() %>% View()

detections_cod_depth_station <- detections_cod_depth %>%
  dplyr::group_by(station_name, quarter) %>% #, month
  dplyr::summarise(n_detections = n(),
                   deploy_latitude = mean(deploy_latitude),
                   deploy_longitude = mean(deploy_longitude))
```

```{r mapcod}

# EMODnet Bathymetry layer
emodnet_tiles <-"https://tiles.emodnet-bathymetry.eu/2020/baselayer/web_mercator/{z}/{x}/{y}.png"
cite_emodnet <- "<a href='https://emodnet.ec.europa.eu'>EMODnet</a>"
attr(cite_emodnet, "class") <- c("html", "character")


# MAP
leaflet() %>%
  addTiles() %>%
    setView(3.3, 51.296, zoom = 8) %>% 
#background
  # addTiles() %>%
  addProviderTiles("Esri.WorldImagery", options = providerTileOptions(opacity = 0.6), group = "satellite") %>%
  leaflet::addTiles(urlTemplate = emodnet_tiles,
                    # options = leaflet::tileOptions(tms = FALSE),
                    attribution = cite_emodnet,
                    group = "EMODnet bathymetry") %>%
  # addRasterImage(bathy_belgium_raster, opacity = 1, colors = "Spectral", group = "bathymetry") %>%
  # addPolygons(data = coastline_BE_poly, opacity = 1, fillColor = "grey", weight = 0, fillOpacity = 0.7, group = "bathymetry") %>% #"#ECE4BF"
  addTiles(group = "OpenStreetMap") %>%
  
# EEZs
  addPolygons(data = EEZs, color = "darkgrey", 
              weight = 2,
              opacity = 1.0,
              label = ~preferredGazetteerName,
              fillOpacity = 0, 
              group = "EEZs") %>%
  
#### area rectangles ####
  addRectangles( #WS1
  lng1 = 3.387, lat1 = 51.365, lng2 = 3.666, lat2 = 51.513,
  fillOpacity = 0.2, weight = 2, color = "grey", group = "<span style=color:grey>receiver areas</span>",
  label = "ws1") %>%
  addRectangles( #WS2
  lng1 = 3.68, lat1 = 51.314, lng2 = 3.859, lat2 = 51.447,
  fillOpacity = 0.2, weight = 2, color = "grey", group = "<span style=color:grey>receiver areas</span>",
  label = "ws2") %>%
  addRectangles( #WS3
  lng1 = 3.99, lat1 = 51.377, lng2 = 4.06, lat2 = 51.450,
  fillOpacity = 0.2, weight = 2, color = "grey", group = "<span style=color:grey>receiver areas</span>",
  label = "ws3") %>%
  # addRectangles( #zeeschelde
  # lng1 = 3.889, lat1 = 50.965, lng2 = 4.510, lat2 = 51.325,
  # fillOpacity = 0.2, weight = 2, color = legend_stations$colour[legend_stations$area == "zeeschelde"], group = "receiver areas") %>%
  addPolygons(data = BPNS, color = "grey",weight = 2, fillOpacity = 0.15, group = "<span style=color:grey>receiver areas</span>",
  label = "bpns") %>%

  # Q1
  addCircleMarkers(data = detections_cod_depth_station %>%
                     dplyr::filter(quarter == 1),
                   lat = ~deploy_latitude,
                   lng = ~deploy_longitude,
                   color = "blue",
                   fillOpacity = 1,
                   weight = 0,
                   radius = ~log(n_detections) * 1.3,
                   label = ~paste0("station: ", station_name, ", Q", quarter, ", n_detect: ", n_detections),
                   group = "<span style=color:blue>Q1</span>") %>%
  # Q2
  addCircleMarkers(data = detections_cod_depth_station %>%
                     dplyr::filter(quarter == 2),
                   lat = ~deploy_latitude,
                   lng = ~deploy_longitude,
                   color = "green",
                   fillOpacity = 1,
                   weight = 0,
                   radius = ~log(n_detections) * 1.3,
                   label = ~paste0("station: ", station_name, ", Q", quarter, ", n_detect: ", n_detections),
                   group = "<span style=color:green>Q2</span>") %>%
  # Q3
  addCircleMarkers(data = detections_cod_depth_station %>%
                     dplyr::filter(quarter == 3),
                   lat = ~deploy_latitude,
                   lng = ~deploy_longitude,
                   color = "orange",
                   fillOpacity = 1,
                   weight = 0,
                   radius = ~log(n_detections) * 1.3,
                   label = ~paste0("station: ", station_name, ", Q", quarter, ", n_detect: ", n_detections),
                   group = "<span style=color:orange>Q3</span>") %>%
  # Q4
  addCircleMarkers(data = detections_cod_depth_station %>%
                     dplyr::filter(quarter == 4),
                   lat = ~deploy_latitude,
                   lng = ~deploy_longitude,
                   color = "red",
                   fillOpacity = 1,
                   weight = 0,
                   radius = ~log(n_detections) * 1.3,
                   label = ~paste0("station: ", station_name, ", Q", quarter, ", n_detect: ", n_detections),
                   group = "<span style=color:red>Q4</span>") %>%
 addLayersControl(position = "topright",
                  overlayGroups = c("<span style=color:blue>Q1</span>", "<span style=color:green>Q2</span>", "<span style=color:orange>Q3</span>", "<span style=color:red>Q4</span>", "<span style=color:grey>receiver areas</span>"),
                  options = layersControlOptions(collapsed = FALSE)) %>%
  # add-ons
  leaflet.extras::addFullscreenControl() %>%
  leafem::addMouseCoordinates() %>%
  addScaleBar(position = "bottomright",
              options = scaleBarOptions(
                maxWidth = 150,
              imperial = FALSE)) %>%
  hideGroup("<span style=color:grey>receiver areas</span>")

```
> The radius of each circle corresponds to the amount of detections at this receiver station.


### Avg depth per month in bpns & ws

```{r deplotPlot}

detections_cod_depth_station_month <- detections_cod_depth %>%
  dplyr::mutate(acoustic_project_code = ifelse(acoustic_project_code %in% c("cpodnetwork", "pc4c"),
                                               "bpns", ifelse(acoustic_project_code %in% c("ws1", "ws2", "ws3"),
                                                               "ws", acoustic_project_code))) %>%
  dplyr::group_by(acoustic_project_code, month) %>%
  dplyr::summarise(mean = mean(depth_m),
                   min = min(depth_m),
                   max = max(depth_m),
                   sd = sd(depth_m))

p_bar_avgdepth <-
ggplot(data = detections_cod_depth_station_month) +
  geom_bar(aes(x = month, y = -max, fill = acoustic_project_code),
           stat = "identity", position = position_dodge(width = 0.9), alpha = 0.35) +
  geom_bar(aes(x = month, y = -mean, colour = acoustic_project_code),
           stat = "identity", position = position_dodge(width = 0.9), linewidth = 1.3, fill = "white") +
  geom_bar(aes(x = month, y = -min, fill = acoustic_project_code),
           stat = "identity", position = position_dodge(width = 0.9), alpha = 0.35) +
  geom_errorbar(aes(x = month, ymin = -mean - sd, 
                    ymax = -mean + sd, group = acoustic_project_code),
                stat = "identity", position = position_dodge(width = 0.9)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(title = "Avg depth per month and receiver area", 
       subtitle = "mean depth (+-sd), min and max in light colours",
       y = "depth in m", x = "month", fill = "area", colour = "area") +
  theme_bw()

p_bar_avgdepth

# ggsave(filename = paste0(getwd(), "/data/data_cod_janr/barplot_avg_depth_bpns_ws.png"), height = 15, width = 17, units = "cm", plot = p_bar_avgdepth)
    
```

### Avg depth per month in all acoustic project codes

```{r deplotPlot2}

detections_cod_depth_station_month <- detections_cod_depth %>%
  # dplyr::mutate(acoustic_project_code = ifelse(acoustic_project_code %in% c("cpodnetwork", "pc4c"),
  #                                              "bpns", ifelse(acoustic_project_code %in% c("ws1", "ws2", "ws3"),
  #                                                              "ws", acoustic_project_code))) %>%
  dplyr::group_by(acoustic_project_code, month) %>%
  dplyr::summarise(mean = mean(depth_m),
                   min = min(depth_m),
                   max = max(depth_m),
                   sd = sd(depth_m))

p_bar_avgdepth2 <-
ggplot(data = detections_cod_depth_station_month) +
  geom_bar(aes(x = month, y = -max, fill = acoustic_project_code),
           stat = "identity", position = position_dodge(width = 0.9), alpha = 0.35) +
  geom_bar(aes(x = month, y = -mean, colour = acoustic_project_code),
           stat = "identity", position = position_dodge(width = 0.9), linewidth = 1.3, fill = "white") +
  geom_bar(aes(x = month, y = -min, fill = acoustic_project_code),
           stat = "identity", position = position_dodge(width = 0.9), alpha = 0.35) +
  geom_errorbar(aes(x = month, ymin = -mean - sd, 
                    ymax = -mean + sd, group = acoustic_project_code),
                stat = "identity", position = position_dodge(width = 0.9)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(title = "Avg depth per month and acoustic project code", 
       subtitle = "mean depth (+-sd), min and max in light colours",
       y = "depth in m", x = "month", fill = "area", colour = "area") +
  scale_fill_brewer(palette = "Dark2") +
  scale_colour_brewer(palette = "Dark2") +
  theme_bw()

p_bar_avgdepth2

# ggsave(filename = paste0(getwd(), "/data/data_cod_janr/barplot_avg_depth_ac_project_codes.png"), height = 15, width = 17, units = "cm", plot = p_bar_avgdepth2)
    
```


### locations of different acoustic project codes

```{r mapStations}

pal <- colorFactor(palette = "Dark2", domain = detections_cod_depth$acoustic_project_code %>% unique())


leaflet() %>%
  addTiles() %>%
  setView(3.3, 51.296, zoom = 8) %>% 
  addPolygons(data = EEZs, color = "darkgrey", 
              weight = 2,
              opacity = 1.0,
              label = ~preferredGazetteerName,
              fillOpacity = 0, 
              group = "EEZs") %>%
  addCircleMarkers(data = detections_cod_depth %>% group_by(station_name, acoustic_project_code) %>%
                     summarise(deploy_latitude = mean(deploy_latitude),
                               deploy_longitude = mean(deploy_longitude)),
                   lat = ~deploy_latitude,
                   lng = ~deploy_longitude,
                   label = ~paste0("station: ", station_name),
                   fillColor = ~pal(acoustic_project_code),
                   weight = 0,
                   radius = 4,
                   fillOpacity = 1) %>%
  addLegend("bottomleft", pal = pal, values = detections_cod_depth$acoustic_project_code %>% unique(),
            opacity = 1)

```
