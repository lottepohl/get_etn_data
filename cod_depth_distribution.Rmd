---
title: "Cod depth distribution"
subtitle: "diurnal patterns, class I, II and above"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Libraries 

# library(devtools)
# devtools::install_github("inbo/etn")
library(etn)
library(dplyr)
library(lubridate)
library(utils)
library(leaflet)
library(tidyverse)
library(knitr)
library(kableExtra)
library(leafem)
library(DT) # for interactive tables

# database connection

con <- etn::connect_to_etn(Sys.getenv("userid"), Sys.getenv("pwd"))

# FUNCTIONS
# function to clean ETN tables
remove_double_cols <- function(animals){
  animals$tag_serial_number <- gsub(",.*","", animals$tag_serial_number)
  animals$tag_type <- gsub(",.*","", animals$tag_type)
  animals$tag_subtype <- gsub(",.*","", animals$tag_subtype)
  animals$acoustic_tag_id <- gsub(",.*","", animals$acoustic_tag_id)
  return(animals)
}

# save data as.rds ####
# folder needs to have a '/' as last character

save_data <- function(data, folder){
  base::saveRDS(data, file = paste0(folder, deparse(substitute(data)), ".rds"))
}

# load rds data ####

load_data <- function(filestring, folder){
  data <- base::readRDS(file = paste0(folder, filestring, ".rds"))
  return(data)
}

```

```{r dataquery, include=F, echo=F}

# PROJECTS
project_codes <- c("rijke_noordzee", "PC4C", "2015_PHD_verhelst_cod", "2010_PHD_Reubens", "codnoise")

#For now: no direct query through the ETN database but load data in folder ./data/data_cod_janr

# ANIMALS
# animals_cod <- etn::get_animals(animal_project_code = project_codes) %>%
#   remove_double_cols()
# save_data(animals_cod, folder = paste0(getwd(), "/data/data_cod_janr/"))
animals_cod <- load_data("animals_cod", folder = paste0(getwd(), "/data/data_cod_janr/"))

# TAG INFORMATION
# tags_cod <- etn::get_tags(acoustic_tag_id = animals_cod$acoustic_tag_id)
# save_data(tags_cod, folder = paste0(getwd(), "/data/data_cod_janr/"))
tags_relevant_cols <- c("tag_serial_number", "sensor_type", "manufacturer", "model", "frequency", "status", "battery_estimated_life", "activation_date", "battery_estimated_end_date", "sensor_slope", "sensor_intercept", "sensor_range", "sensor_unit", "sensor_transmit_ratio", "accelerometer_algorithm", "sensor_transmit_ratio", "owner_pi", "step1_min_delay", "step1_max_delay", "step1_duration", "step1_acceleration_duration")
# "acoustic_tag_id", "tag_type", "acoustic_tag_id_alternative",
tags_cod <- load_data("tags_cod", folder = paste0(getwd(), "/data/data_cod_janr/"))

# only keep the animals for which we have depth sensor information
animals_cod_depth <- animals_cod %>%
  dplyr::left_join(tags_cod %>% 
                     dplyr::select(all_of(tags_relevant_cols)),
                   by = "tag_serial_number") %>%
  dplyr::filter(sensor_type %in% c("P", "pressure")) %>% # only retain sensor types "P"/"pressure"
  dplyr::filter(length1 > 19.9) %>% #separate into age classes, from Reubens et al., 2013 (Mar. Env. Res.)
  dplyr::mutate(age_group = ifelse(length1 < 43.3, 1, 
                                   ifelse(length1 < 54.6, 2, 
                                          ifelse(length1 < 61.2, 3,
                                                 4))) %>%
                  factor(levels = c(1, 2, 3, 4))) # age class 4 is categorized as all cod longer than 61.2 cm


# making sure there really are no cods in group III
# animals_cod_depth %>% 
#   dplyr::filter(length1 %>% between(54.6, 61.2)) %>% 
#   View()

# animals_cod_depth$sensor_type %>% unique()
# animals_cod_depth$animal_project_code %>% unique()

#both are 60
# animals_cod_depth$acoustic_tag_id %>% unique() %>% length() 
# animals_cod_depth$tag_serial_number %>% unique() %>% length()

# DETECTIONS
# detections_cod <- etn::get_acoustic_detections(
#   acoustic_tag_id = animals_cod_depth$acoustic_tag_id %>% unique())
# 
# save_data(detections_cod, folder = paste0(getwd(), "/data/data_cod_janr/"))
load_data("detections_cod", folder = paste0(getwd(), "/data/data_cod_janr/"))

# detections_cod$tag_serial_number %>% unique() %>% length()
# detections_cod$date_time %>% min()
# detections_cod$date_time %>% max()

```

# General Information

* `r animals_cod %>% nrow()` tagged cod found for the projects codes `r project_codes`.

* `r animals_cod_depth %>% nrow()` were equipped with a depth sensor, out of which `r detections_cod$tag_serial_number %>% unique() %>% length()` were detected by acoustic receivers.

<!-- * `r animals_cod$acoustic_tag_id %>% unique() %>% length()` unique acoustic tag ids are in the cod data, and no NAs. To me that looks like some acoustic tag ids are double, just fyi. -->

```{r histAgeGroups}
p_hist_age_groups <- 
  ggplot(data = animals_cod_depth) +
  geom_histogram(aes(x = age_group), stat="count") + 
  labs(x = "age group", y = "number of individuals", title = "Age class distribution") +
  scale_y_continuous(expand = c(0,0)) +
  theme_bw()

p_hist_age_groups
```
There are no individuals in age group 3, and `r animals_cod_depth%>% filter(age_group == 4) %>% nrow()` animal in group 4 (total length = `r animals_cod_depth%>% filter(age_group == 4) %>% select(length1) %>% pull()` cm).


```{r depthvals, include=F, echo=F}

detections_cod_depth <- detections_cod %>%
  left_join(animals_cod_depth %>% 
              dplyr::select(tag_serial_number, sensor_slope, sensor_intercept),
            by = join_by(tag_serial_number)) %>%
  dplyr::mutate(depth_m = (sensor_value * sensor_slope) + sensor_intercept) %>% #calc depth
  dplyr::filter(depth_m > 0) %>% #filter out weird depths(i.e., depths < 0)
  # some stats
  dplyr::mutate(hour_of_day = lubridate::hour(date_time) %>% as.factor(),
                year = lubridate::year(date_time),
                month = lubridate::month(date_time, label = T, abbr = T),
                month_count = lubridate::month(date_time, label = F),
                monthyear = paste0(month, "-", year),
                day_of_year = yday(date_time))
  
rm(detections_cod)
# detections_cod_depth %>% head() %>% View()

p_hist_depth <- 
  ggplot(data = detections_cod_depth) +
  geom_histogram(aes(x = depth_m)) + 
  labs(x = "depth in m", y = "number of detections", title = "Depth distribution of detections") +
  scale_y_continuous(expand = c(0,0)) +
  theme_bw()

p_hist_depth

# some of the detections have negative depth values. that cannot be. let's investigate why that is

tags_weird_depths <- 
  tags_cod %>%
  dplyr::filter(tag_serial_number %in% (detections_cod_depth %>% 
                     dplyr::filter(depth_m < 0) %>%
                     dplyr::select(tag_serial_number) %>% 
                     unique() %>% pull()))

# tags_weird_depths %>% View()

# see which tags give depth values <0
# tags_cod %>% 
#   dplyr::filter(tag_serial_number %in% (tags_weird_depths %>% pull())) %>%
#   View()

# see what animals have sensor slope = 0
# animals_cod_depth %>% 
#   dplyr::filter(sensor_slope == 0)  %>%
#   View()

# detections_smallslope <- detections_cod_depth %>%
#            dplyr::filter(tag_serial_number %in% (tags_weird_depths %>% 
#                                                    # dplyr::filter(sensor_slope != 0) %>% 
#                                                    dplyr::select(tag_serial_number) %>% 
#                                                    pull())) %>%
#   dplyr::group_by(tag_serial_number) %>%
#   dplyr::summarise(min_depth = depth_m %>% min(),
#                    mean_depth = depth_m %>% mean(),
#                    max_depth = depth_m %>% max())

# make csv file with tags that have sensor slope == 0 or almost 0
# write.csv(tags_weird_depths %>% dplyr::filter(sensor_slope == 0), 
#           file = paste0(getwd(), "/data/cod_tags_sensor_slope_0.csv"))

```

## Depths per hour of the day

### Summary table

```{r depthbins}

depth_per_hour <- detections_cod_depth %>%
  dplyr::group_by(hour_of_day) %>%
  dplyr::summarise(min_depth = depth_m %>% min() %>% round(digits = 2),
                   mean_depth = depth_m %>% mean() %>% round(digits = 2),
                   sd_depth = depth_m %>% sd() %>% round(digits = 2),
                   median_depth = depth_m %>% median() %>% round(digits = 2),
                   max_depth = depth_m %>% max() %>% round(digits = 2),
                   n_individuals = tag_serial_number %>% unique() %>% length() %>% round(digits = 2),
                   n_detections = n() %>% round(digits = 2))

depth_per_hour_long <- depth_per_hour %>%
  tidyr::pivot_longer(cols = min_depth:max_depth, names_to = "summary_statistic", values_to = "value")

DT::datatable(depth_per_hour,
              rownames = F,
              filter = 'bottom',
              extension = 'Buttons',
              options = list(
                pageLength = 30, 
                dom = 'Bfrtip',
                buttons = c('pdf', 'csv', 'excel', 'print','copy'),
                columnDefs = list(list(className = 'dt-center', targets = '_all'))
              )
            )

```

### Boxplots

```{r deptBoxplot}
# ALL DETECTIONS
p_box_tod <- ggplot(data = detections_cod_depth) +
  geom_boxplot(aes(x = hour_of_day, y = -depth_m)) +
  labs(title = "Depth per hour of the day across all detections", x = "Hour of the day", y = "Depth in m") +
  theme_bw()
p_box_tod


p_points_tod <- ggplot(data = depth_per_hour_long) +
  geom_poiny(aes(x = hour_of_day, y = -value, colour = summary_statistic)) +
  # geom_errorbar(aes(x = hour_of_day, ymin = -summary_statistic$mean_depth - summary_statistic$sd_depth, ymax = -summary_statistic$mean_depth + summary_statistic$sd_depth))+
  labs(title = "Depth per hour of the day across all detections", x = "Hour of the day", y = "Depth in m", colour = "") +
  theme_bw()
p_points_tod
# todo: geom ribon with max and min, new geom errorbar with deoth_per_hour (not the long df())

p_points_tod <- ggplot(data = depth_per_hour) +
  geom_bar(aes(x = hour_of_day, y = -mean_depth), stat = "identity") +
  # geom_ribbon(aes(x = hour_of_day, ymin = -max_depth, ymax = -min_depth)) +
  # geom_errorbar(aes(x = hour_of_day, ymin = -mean_depth - sd_depth, ymax = -mean_depth + sd_depth)) +
  labs(title = "Depth per hour of the day across all detections", x = "Hour of the day", y = "Depth in m") +
  theme_bw()
p_points_tod
# todo: geom ribon with max and min, new geom errorbar with deoth_per_hour (not the long df())


# p_smooth_tod <- ggplot(data = detections_cod_depth %>%
#                          dplyr::slice_sample(n = 1000)) +
#   geom_smooth(aes(x = hour_of_day, y = -depth_m)) +
#   labs(title = "Depth per hour of the day across all detections", x = "Hour of the day", y = "Depth in m") +
#   theme_bw()
# p_smooth_tod

# PER MONTH
p_box_tod_month <- ggplot(data = detections_cod_depth) +
  geom_boxplot(aes(x = hour_of_day, y = -depth_m)) +
  labs(title = "Depth per hour of the day, per month", x = "Hour of the day", y = "Depth in m") +
  facet_wrap(~month) +
  scale_x_discrete(breaks = seq(0,24, by = 2)) +
  theme_bw()

p_box_tod_month



```

