---
title: "Acoustic Deployments Overview"
# subtitle: "receiver readout September, 2023"
output:
  flexdashboard::flex_dashboard:
    # navbar:
    #   - { title: "Receiver maintenance", href: "https://example.com/about", align: left }
    source_code: embed
    orientation: rows
    horizontal_layout: fill
    theme: 
      version: 4
      bootswatch: litera
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warnings = F)

# Libraries 
library(flexdashboard)
# library(devtools)
# devtools::install_github("inbo/etn")
library(etn) # to retrieve data from the etn database
library(dplyr) # for data wrangling
library(lubridate) # for timeanddate operations
library(crosstalk) # for on-the-fly data filtering
library(utils) # for miscellaneous operation
library(htmltools) # for html components
library(leaflet)# for interactive maps
library(knitr) # for knitting the document into a e.g. .html file
library(leafem) # for extras in leaflet maps
library(DT) # for interactive tables
options(DT.options = list(

                          scrollY="200px", #500

                          scrollX="100px", #200

                          # pageLength = 5, 

                          autoWidth = TRUE))
library(mregions2) # to query marine geospatial boundaries

# database connection

con <- etn::connect_to_etn(Sys.getenv("userid"), Sys.getenv("pwd"))

BPNS <- mregions2::gaz_search(3293) %>% mregions2::gaz_geometry()

```

```{css, echo=FALSE}
# p {
#   font-size: 15px;
# }
.small {
  zoom: 75%;
}
# .zoom
# {
#     zoom: 200%;
# }
```


<!-- **Database Query:** -->

```{r get deployments, include=FALSE}
# FROM CROSSTALK PACKAGE
# all_deployments <- etn::get_acoustic_deployments(open_only = F)
# all_receivers <- etn::get_acoustic_receivers()
# all_acoustic_projects <- etn::get_acoustic_projects()

# get currently active deployments
current_deployments <- etn::get_acoustic_deployments(con, 
                                                  acoustic_project_code = "bpns", # c("ws1", "ws2")
                                                  open_only = TRUE) 

# get information on receivers currently deployed
current_receivers <- etn::get_acoustic_receivers(con, receiver_id = current_deployments$receiver_id)

# get last deployment of each of the receivers currently deployed
last_deployments <- 
  etn::get_acoustic_deployments(con, receiver_id = current_deployments$receiver_id,
                                open_only = FALSE) %>%
    dplyr::filter(!deployment_id %in% current_deployments$deployment_id) %>% #remove currently open deployments (because we want the previous deployments)
    dplyr::group_by(receiver_id) %>%
    dplyr::summarise(previous_recover_date_time = recover_date_time %>% max(na.rm = T), # save other relevant columns at the last deployment date time
                     # id_1 = deployment_id[1],
                     # id_2 = deployment_id[2],
                     previous_deploy_date_time = deploy_date_time[which.max(recover_date_time)],
                     previous_battery_installation_date = battery_installation_date[which.max(recover_date_time)],
                     previous_battery_estimated_end_date = battery_estimated_end_date[which.max(recover_date_time)]
                     ,previous_deployment_id = deployment_id[which.max(recover_date_time)]
                     )
```

<!-- # Some info about the deployments -->

<!-- The data is a bit messy and sometimes incomplete: -->

<!-- - Not all active deployments have both `battery_installation_date` and `battery_estimated_end_date`.  -->
<!-- - Sometimes, either `battery_installation_date` or `battery_estimated_end_date` lie in the past.  -->
<!-- - Sometimes, `battery_installation_date` and `battery_estimated_end_date` are the same. -->



<!-- 1. Is there a value for `battery_estimated_end_date` (iow != NA)? -->

<!-- If yes, go to 2. -->

<!-- 2. Is `battery_estimated_end_date` different from `battery_installation_date`? -->

<!-- If yes, go to 3. -->

<!-- 3. Does `battery_estimated_end_date` lie in the past? -->

<!-- If yes: colour specifically on map and in table. -->
<!-- If no, go to 4. -->

<!-- 4. Is `battery_estimated_end_date` closer than 3 months from October 1, 2023? -->

<!-- If yes: Battery needs to be changed: colour red in map and table. -->

<!-- 5. Is there a value for `battery_installation_date`? -->

<!-- If yes, go to 5. -->

<!-- 6.  -->

```{r datacleaning, include=FALSE}

# new column to indicate if battery needs to be changed

current_deployments <- 
  current_deployments %>%
    dplyr::mutate(needs_battery_change = NA,
                colour = "black") %>%
    dplyr::select(!starts_with(c("ar", "log", "sync"))) %>%
    dplyr::left_join(current_receivers %>% # add information about the acoustic receivers into the deployment table
                     dplyr::select(!starts_with("ar")),
                    by = join_by(receiver_id)) %>%
    dplyr::left_join(last_deployments,
                     by = join_by(receiver_id)) %>%
    dplyr::mutate(across(where(is.POSIXct), ~ format(., "%Y-%m-%d")),
                  battery_estimated_life_months = battery_estimated_life %>% as.integer(),
                  battery_estimated_life_months = (battery_estimated_life_months / 30) %>% round(digits = 0)
                  ) #change all date formats to show only year-month-day


# QC ALGORITHM

# this algorithm will split the list of currently active deployments into deployments that 
# 0) seem to contain correct info: deployment_date_time and battery_installation_date both lie in the past, while battery_estimated_end_date lies in the future
# 1) are most likely not active anymore and should be closed (if deploy_date_time more than 2yrs ago (cutoff date realistic?), then check with receiver status: is receiver lost? Either way probably close deployment...)
# 2) do not have a battery installation date and no correct estimated end date (-> check previous deployment of each receiver, and if battery installation date exists and is less than 13 months ago, take the same battery installation date)
# 3) have no battery installation date but a correct battery estimated end date (-> if battery_end_date existent & lies in future, take battery_end_date - 13 months)
# 4) have a battery installation date that is in the future (-> check if battery_end_date is there & in the future: if not, set battery_installation_date as battery_estimated_end_date)
# 5) have a battery estimated end date that is the same as the battery installation date, and lies in the past (-> set battery estimated end date as battery installation date + battery_lifetime_months)
cutoff_year_closed_deployment <- 2

# QC check 0): all battery info entered correctly
current_deployments_0 <- 
  current_deployments %>%
    dplyr::filter(deploy_date_time < Sys.Date(),
                  battery_installation_date < Sys.Date(),
                  battery_estimated_end_date > Sys.Date())

# QC check 1): non-active deployments
current_deployments_1 <- 
  current_deployments %>%
    dplyr::filter(deploy_date_time < (Sys.Date() - lubridate::years(cutoff_year_closed_deployment)))

# QC check 2): battery installation date was not given or in the future (-> check previous deployment of each receiver)
current_deployments_2 <- 
  current_deployments %>%
    dplyr::filter(battery_installation_date %>% is.na() |
                  battery_installation_date > Sys.Date(),
                  deploy_date_time > (Sys.Date() - lubridate::years(cutoff_year_closed_deployment))) # filter out deployments that are presumably closed or lost

# QC check 3: battery estimated end date not set or wrong
current_deployments_3 <- 
  current_deployments %>%
    dplyr::filter(battery_estimated_end_date %>% is.na() |
                  battery_estimated_end_date < Sys.Date(),
                  deploy_date_time > (Sys.Date() - lubridate::years(cutoff_year_closed_deployment))) # filter out deployments that are presumably closed or lost


  
# quick and dirty algorithm
  
cutoff_date <- Sys.Date() + months(3)
  
current_deployments <- current_deployments %>%
  dplyr::mutate(needs_battery_change = ifelse(battery_estimated_end_date < cutoff_date, 
                                              1, 
                                              0),
                colour = ifelse(needs_battery_change == 1, 
                                'orange', ##F9938E
                                '#00639E'), #38A9DC
                colour = colour %>% tidyr::replace_na('#303030')) %>% 
  dplyr::arrange(desc(needs_battery_change))

  
```

<!-- Things to make interactive: -->
<!-- - acoustic project code [x]-->
<!-- - cutoff date for old deployments -->
<!-- - date of battery estimated end date fro maintenance -->

# 1. Overview {#overview}

Row {data-height=100}
------------------------------------

### {#etn-logo data-width=150}

<!-- [![ETN Logo](images/etn_logo.png)](https://external.ink?to=/europeantrackingnetwork.org/en){width=5%} -->

```{r ETN-logo}

# Image URL
image_url <- "https://europeantrackingnetwork.org/sites/europeantrackingnetwork.org/files/managed/logo_ETN.png"

# Hyperlink URL
hyperlink_url <- "https://europeantrackingnetwork.org/en"

# Combine image and hyperlink within an HTML block
html_block <- div(
  img(src = image_url, style = "width:90%; height:70%;"),
  a(href = hyperlink_url, target = "_blank", "ETN website")
)

# Display the HTML block
html_block
```


<!-- ```{r,  out.width = "10%", out.height = "10%"} -->
<!-- # image_link <- function(image,url){ -->
<!-- #   htmltools::a( -->
<!-- #     target="_blank", -->
<!-- #     href=url, -->
<!-- #     htmltools::img(src=image) #image does not load for some reason -->
<!-- #     ) -->
<!-- # } -->
<!-- #  -->
<!-- # image_link(image = paste0(getwd(), "/images/etn_logo.png"), -->
<!-- #              # "https://europeantrackingnetwork.org/sites/europeantrackingnetwork.org/files/managed/logo_ETN.png", -->
<!-- #            url = "https://europeantrackingnetwork.org/en") -->

<!-- include_graphics("https://europeantrackingnetwork.org/sites/europeantrackingnetwork.org/files/managed/logo_ETN.png") #static implementation without hyperlink -->

<!-- htmltools::a(href = "https://europeantrackingnetwork.org/en") -->
<!-- ``` -->

### active deployments {#vBox-active-deployments}

```{r}
num_deployments <- current_deployments %>% nrow()

flexdashboard::valueBox(num_deployments,
                        caption = "receivers are currently deployed",
                        icon = "fa-anchor",
                        color = 'lightgray')
```

### deployments that need manual check {#gauge-receiversneedQC}

```{r}
num_receivers_manualcheck <- 
  current_deployments %>%
    dplyr::filter(needs_battery_change %>% is.na()) %>%
    nrow()

flexdashboard::gauge(value = num_receivers_manualcheck,
                     href = '#deploymentsQC',
                     min = 0, max = num_deployments, 
                     gaugeSectors(success = c(0, (num_deployments/3)), # show a warning color when 2/3 of currently active receivers need change soon
                                  warning = c((num_deployments/3), 2*(num_deployments/3)),
                                  danger = c(2*(num_deployments/3), num_deployments),
                                  colors = c("black", "darkgrey", "lightgrey")),
                     abbreviateDecimals = 0)

# flexdashboard::valueBox(num_receivers_manualcheck,
#                         caption = "deployments need manual updating on the ETN platform",
#                         icon = "fa-user-check",
#                         colour = current_deployments %>% 
#                             dplyr::filter(needs_battery_change %>% is.na()) %>% 
#                             dplyr::select(colour) %>% 
#                                    unique() %>% 
#                                    pull())
```

### receivers requiring maintenance {#gauge-receiversMaintenance}

```{r}
num_receivers_batterychange <- 
  current_deployments %>%
    dplyr::filter(needs_battery_change == 1) %>%
    nrow()

# gauge showing how many receivers require battery change
flexdashboard::gauge(value = num_receivers_batterychange,
                     href = '#table-receiverInfo',
                     min = 0, max = num_deployments, 
                     gaugeSectors(success = c(0, (num_deployments/3)), # show a warning color when 2/3 of currently active receivers need change soon
                                  warning = c((num_deployments/3), 2*(num_deployments/3)),
                                  danger = c(2*(num_deployments/3), num_deployments),
                                  colors = c("black", "darkgrey", "lightgrey")),
                     abbreviateDecimals = 0)

# flexdashboard::valueBox(num_receivers_batterychange,
#                         caption = "receivers require a battery change",
#                         icon = "fa-gears")
```


Row {data-height=900}
------------------------------------

### Quick info {#about-quickInfo data-width=250}

<!-- FROM CROSSTALK PACKAGE -->
<!-- ```{r} -->

<!-- acoustic_projects_shared <- -->
<!--   all_acoustic_projects %>% -->
<!--     dplyr::group_by(project_code) %>% -->
<!--     SharedData$new() -->

<!-- crosstalk::filter_select(id = "current_acoustic_project", -->
<!--                          label = "Choose an acoustic project", acoustic_projects_shared, ~project_code, multiple = TRUE) -->

<!-- ``` -->

<!-- ```{js} -->
<!-- setDefaultValue("current_acoustic_project", "bpns"); -->
<!-- ``` -->



This dashboard gives an overview on acoustic deployments in a specific acoustic project.

It helps to:

* Identify deployments with missing information 

<!-- &rarr; page *Deployments requiring QC* -->
* Get a visual overview of current receiver deployments 

<!-- &rarr; page *Map* -->
* plan receivers maintenance operations 

<!-- &rarr; page *Table with receiver info* -->


### Map {#about-map data-width=750}


```{r receivermap, out.width="100%", fig.align = 'center', echo=FALSE}

# SHARED DATA (crosstalk R package)
# shared_data %>%
#   plot_ly(type = "scatter", x = ~month_name, y = ~n,
#           color = ~carrier, name = ~carrier,
#           mode = "markers+lines", colors = unname(pals::glasbey())
#   ) %>%
#   layout(
#     yaxis = list(title = "", fixedrange = TRUE),
#     xaxis = list(title = "Flights", rangeslider = list(type = "date"))
#   )
# current_deployments <- 
#   current_deployments %>%
#     dplyr::filter(acoustic_project_code %in% acoustic_projects_shared$project_code)


# ICONS

## North Arrow
north.arrow.icon <-
  "<img src='https://www.clipartbest.com/cliparts/yTo/Lgr/yToLgryGc.png' style='width:40px;height:50px;'>"

## Anchor icon for deployments
icon_anchor <- leaflet::makeAwesomeIcon(
  icon = "anchor",
  iconColor = 'lightgray',
  markerColor =  ifelse(current_deployments$needs_battery_change %>% is.na(), 'black', 
                     ifelse(current_deployments$needs_battery_change == 1, 'orange', 'darkblue')),
  library = "fa",
  squareMarker = F
  # ,spin = T
)

receiver_map <- 
  leaflet() %>% #height=500, width=1100 
  addTiles() %>%
  addPolygons(data = BPNS, color = "darkgrey",
              weight = 2,
              opacity = 1.0,
              fillOpacity = 0) %>%

    addAwesomeMarkers(data = current_deployments,
                   icon = icon_anchor,
                   lat = ~deploy_latitude,
                   lng = ~deploy_longitude,
                   # radius = 10,
                   # opacity = 1,
                   # color = "black",
                   # weight = 1,
                   # fillOpacity = 1,
                   # fillColor = ~colour,
                   popup = ~paste(
                           "<b>Station:</b> ", station_name, "<br>",
                           "<b>Receiver id:</b> ", receiver_id, "<br>",
                           "<b>Deployment id:</b> ", deployment_id, "<br>",
                           "<b>Battery installation:</b> ",battery_installation_date, "<br>",
                           "<b>Estimated battery end:</b> ", battery_estimated_end_date, "<br>", #
                           "<b>Receiver battery life (months):</b> ", battery_estimated_life_months, "<br>",
                           "<b>Battery status:</b> ", ifelse(needs_battery_change %>% is.na(), "Missing information",
                                                             ifelse(needs_battery_change == 1, "Needs battery change", "No battery change needed"))
                           ),
                     group = "zoom to data",
                   label = ~paste0("Station: ", station_name)
                   ) %>%
  
  addLegend(position = "topright", opacity = 1,
            colors = current_deployments$colour %>% unique(), labels = c("battery needs change", "battery is OK", "missing information")) %>%
  leafem::addMouseCoordinates() %>%
  leaflet::addScaleBar(position = "topright",
              options = scaleBarOptions(
              maxWidth = 150,
              imperial = FALSE)) %>%
  leaflet::addControl( html = north.arrow.icon,
              position = "topleft",
              className = "fieldset {border: 0;}") %>%
  leafem::addHomeButton(group = "zoom to data",
                        position = "topleft")

receiver_map


```

> When you hover over the map, the fields `battery_installation_date` and `battery_estimated_end_date` are displayed. By clicking on a receiver, the fields `station_name`, `receiver_id`, `deploy_latitude` and `deploy_longitude` are displayed.

<!-- Row {data-height=150} -->
<!-- ------------------------------------ -->

<!-- This data overview was created on behalf of the European Tracking Network (ETN) -->


# 2. Manual Check {#deploymentsQC}

Row {data-height=200}
-------------------------------------

### Filter options {data-width = 200}

<!-- ```{r} -->
<!-- #THIS IS WHERE I STOPPED NOV 17 -->
<!-- shared_data <- -->
<!--   all_acoustic_projects %>% -->
<!--     dplyr::group_by(project_code) %>% -->
<!--     SharedData$new() -->

<!-- crosstalk::filter_select(id = "current_acoustic_project", -->
<!--                          label = "Choose an acoustic project", shared_data, ~project_code, multiple = TRUE) -->

<!-- filter_select( -->
<!--   "daily_time_series_carrier", -->
<!--   "Choose carrier", -->
<!--   shared_data, -->
<!--   ~carrier, -->
<!--   multiple = TRUE -->
<!-- ) -->
<!-- ``` -->

<!-- ```{js} -->
<!-- setDefaultValue("current_acoustic_project", "bpns"); -->
<!-- ``` -->



<!-- ### *Was all deployment data correctly uploaded to the ETN database?* -->


<!-- The following tables show the currently open deployments according to different categories: -->

<!-- *1.* Receivers are **lost** or deployment is not active anymore | *2.* Battery **installation** date is empty | *3.* Battery estimated **end** date is empty -->


### Deployments that need manual check {#deploymentsQC-vBox}

<!-- todo: hrefs to tables -->

```{r}
flexdashboard::valueBox(num_receivers_manualcheck,
                        href = 'https://www.lifewatch.be/etn/login',
                        caption = "deployments need a manual update <br> on the ETN portal, divided into 3 categories",
                        icon = "fa-circle-exclamation",
                        color = 'lightgray')
# 
# caption = "deployments need a manual update on the ETN portal, because: <br>
#                                    <b>1.</b> Receivers are <b>lost</b> or deployment is not active anymore <br>
#                                    <b>2.</b> Battery <b>installation</b> date is empty/wrong <br>
#                                    <b>3.</b> Battery <b>estimated end</b> date is empty/wrong <br>",
```

### *Category 1:* Receivers are **lost** or deployment is not active anymore {#deploymentsQC-gauge-lost}

```{r}
num_deployments_1 <- 
  current_deployments_1 %>%
    nrow()

flexdashboard::gauge(value = num_deployments_1,
                     min = 0, max = num_receivers_manualcheck,
                     gaugeSectors(success = c(0, (num_receivers_manualcheck/3)), # show a warning color when 2/3 of currently active receivers need change soon
                                  warning = c((num_receivers_manualcheck/3), 2*(num_receivers_manualcheck/3)),
                                  danger = c(2*(num_receivers_manualcheck/3), num_receivers_manualcheck),
                                  colors = c("black", "darkgrey", "lightgrey")),
                     abbreviateDecimals = 0)
```

### *Category 2:* deployments with empty/wrong battery **installation** date {#deploymentsQC-gauge-noStart}

```{r}
num_deployments_2 <- 
  current_deployments_2 %>%
    nrow()

flexdashboard::gauge(value = num_deployments_2,
                     min = 0, max = num_receivers_manualcheck, 
                     gaugeSectors(success = c(0, (num_receivers_manualcheck/3)), # show a warning color when 2/3 of currently active receivers need change soon
                                  warning = c((num_receivers_manualcheck/3), 2*(num_receivers_manualcheck/3)),
                                  danger = c(2*(num_receivers_manualcheck/3), num_receivers_manualcheck),
                                  colors = c("black", "darkgrey", "lightgrey")),
                     abbreviateDecimals = 0)
```

### *Category 3:* deployments with empty/wrong battery **estimated end** date *(Category 3)* {#deploymentsQC-gauge-noEnd}

```{r}
num_deployments_3 <- 
  current_deployments_3 %>%
    nrow()

flexdashboard::gauge(value = num_deployments_3,
                     min = 0, max = num_receivers_manualcheck,
                     gaugeSectors(success = c(0, (num_receivers_manualcheck/3)), # show a warning color when 2/3 of currently active receivers need change soon
                                  warning = c((num_receivers_manualcheck/3), 2*(num_receivers_manualcheck/3)),
                                  danger = c(2*(num_receivers_manualcheck/3), num_receivers_manualcheck),
                                  colors = c("black", "darkgrey", "lightgrey")),
                     abbreviateDecimals = 0)
```

  
Row {.tabset .tabset-fade data-height=800}
-------------------------------------

###  *Category 1:* Lost receivers {#deploymentsQC-table-lost}

Advised action for the following `r current_deployments_1 %>% nrow()` deployments: **closing the deployment** and/or updating the receiver status.

```{r table QC1}
DT::datatable(current_deployments_1 %>%
              dplyr::select(deployment_id, status, battery_installation_date, battery_estimated_end_date, deploy_date_time, 
                             station_name, deploy_latitude, deploy_longitude, acoustic_project_code, receiver_id),
              rownames = F,
              filter = 'bottom', 
              extension = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('pdf', 'csv', 'excel', 'print','copy'),
                pageLength = current_deployments_1 %>% nrow(),
                autoWidth = TRUE, 
                columnDefs = list(list(className = 'dt-center', targets = '_all')))
              ) %>%
  formatStyle(
  c('receiver_id', 'battery_estimated_end_date'),
  fontWeight = "bold")

```

###  *Category 2:* No battery installation date {#deploymentsQC-table-noStart}

For the following `r current_deployments_2 %>% nrow()` deployments, the `battery_installation_date` was either not set or lies in the future.

Advised action: **Update the `battery_installation_date`** from the previous deployment, if given there. 

```{r table QC2}
DT::datatable(current_deployments_2 %>%
              dplyr::select(deployment_id, battery_installation_date, battery_estimated_end_date, deploy_date_time, 
                             previous_battery_installation_date, previous_recover_date_time,
                             station_name, deploy_latitude, deploy_longitude, acoustic_project_code, receiver_id, previous_deployment_id),
              rownames = F,
              filter = 'bottom', 
              extension = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('pdf', 'csv', 'excel', 'print','copy'),
                pageLength = current_deployments_2 %>% nrow(),
                autoWidth = TRUE, 
                columnDefs = list(list(className = 'dt-center', targets = '_all')))
              ) #%>%
  # formatStyle(
  # c('receiver_id', 'battery_estimated_end_date'),
  # fontWeight = "bold") %>%
  # formatStyle(
  # 'needs_battery_change',
  # backgroundColor = styleEqual(c(0, 1), c('#90BF87', '#F9938E')))

```

###  *Category 3:* No battery estimated end date {#deploymentsQC-table-noEnd}

For the following `r current_deployments_3 %>% nrow()` deployments, the `battery_estimated_end_date` is missing or lies in the past.

Advised action: **Update the `battery_estimated_end_date`** according to the `battery_installation_date` and the `battery_estimated_life`.

```{r table QC3}
DT::datatable(current_deployments_3 %>%
              dplyr::select(deployment_id, battery_installation_date, battery_estimated_end_date, deploy_date_time, 
                             previous_battery_installation_date, previous_recover_date_time,
                             station_name, deploy_latitude, deploy_longitude, acoustic_project_code, receiver_id, previous_deployment_id),
              rownames = F,
              filter = 'bottom', 
              extension = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('pdf', 'csv', 'excel', 'print','copy'),
                pageLength = current_deployments_3 %>% nrow(),
                autoWidth = TRUE, 
                columnDefs = list(list(className = 'dt-center', targets = '_all')))
              ) #%>%
  # formatStyle(
  # c('receiver_id', 'battery_estimated_end_date'),
  # fontWeight = "bold") %>%
  # formatStyle(
  # 'needs_battery_change',
  # backgroundColor = styleEqual(c(0, 1), c('#90BF87', '#F9938E')))

```

<!-- > To aid with manual data entry in the ETN portal, information on the previous deployment is given: Deployment and recover dates, the battery installation and estimated end dates. -->

# 3. Plan Receiver Maintenance {#table-receiverInfo}

### Information on currently active deployments with receiver battery status
<!-- This table shows the battery status of each acoustic receiver currently deployed -->

<!-- interactive table with `DT` package -->

```{r receiverdt, out.width="100%", include=TRUE, echo=FALSE}

DT::datatable(current_deployments %>%
              dplyr::select(receiver_id, needs_battery_change, station_name, deploy_latitude, deploy_longitude, 
                             battery_installation_date, battery_estimated_end_date,  deploy_date_time, acoustic_project_code),
              rownames = F,
              filter = 'top', 
              extension = 'Buttons',
              options = list(
                pageLength = current_deployments %>% nrow(),
                dom = 'Bfrtip',
                buttons = c('pdf', 'csv', 'excel', 'print','copy'),
                pageLength = 10,
                autoWidth = TRUE, columnDefs = list(list(className = 'dt-center', targets = '_all')))
              ) %>%
  formatStyle(
  c('receiver_id', 'battery_estimated_end_date'),
  fontWeight = "bold") %>%
  formatStyle(
  'needs_battery_change',
  color = styleEqual(c(1, 0), c('black', 'white')),
  backgroundColor = styleEqual(c(0, 1, NA), c('#00639E', 'orange', '#303030')))

```
