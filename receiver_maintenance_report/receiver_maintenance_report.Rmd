---
title: "Receiver report"
subtitle: "maintained and lost receivers, 2012 to 2023"
author: "Lotte Pohl"
date: "18/10/2023"
output: 
  html_document:
    theme: readable 
    toc_float: true
    toc: true 
    number_sections: false
    toc_depth: 2
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```


```{r preparing datasets, include = FALSE}
# LIBRARIES
# fundamentals
# library(devtools)
# devtools::install_github("lifewatch/mregions2")
# library(flexdashboard)
library(etn)
library(knitr)
# library(shiny)
library(mregions2)

# data wrangling
library(readr)
# library(tidyverse)
library(tidyr)
library(lubridate)
library(dplyr)
library(utils)
# library(sf)
library(purrr)
library(glue)

# maps
library(leaflet)
library(leafem)
library(leaflet.extras)

# plotting and tables
library(DT) # for interactive tables
library(ggplot2)
# library(kableExtra)
library(plotly)
library(scico) #colour palettes
library(gridExtra)
# library(ggridges)


# DATABASE CONNECTION
con <- etn::connect_to_etn(Sys.getenv("userid"), Sys.getenv("pwd"))

# DATA QUERIES

## 1. acoustic project codes
all_acoustic_projects <- etn::list_acoustic_project_codes() %>% dplyr::as_tibble()
acoustic_projects_BE <- c("bpns", "ws1", "ws2", "ws3", "zeeschelde") #all receivers maintained in BE should be in those projects
potential_acoustic_projects <- c("Apelafico", "bovenschelde", "cpodnetwork", "ETN_project_group_1", "ETN_project_group_4", "ETN_Workshop_group2", "FISHINTEL", "JJ_Belwind", "lifewatch", "PelFish", "PhD_Parcerisas", "rt2020_zeeschelde", "SeaMonitor") #, "PrePARED""Noordzeekanaal", "North_sea_wrecks"

## 2. acoustic deployments (from the acoustic project codes above)
# deployments_BE <- etn::get_acoustic_deployments(con, acoustic_project_code = acoustic_projects_BE)
# deployments_BE_potential <- etn::get_acoustic_deployments(con, acoustic_project_code = potential_acoustic_projects)

deployments_BE_all <- etn::get_acoustic_deployments(con, acoustic_project_code = c(potential_acoustic_projects, acoustic_projects_BE)) %>%
  dplyr::mutate(deploy_year = deploy_date_time %>% lubridate::year(),
                deploy_year = ifelse(deploy_year > 2023, 2023, deploy_year)) 

## acoustic_project_codes mean lat and lon
acoustic_projects_location <- deployments_BE_all %>%
  dplyr::group_by(acoustic_project_code) %>%
  dplyr::summarise(deploy_latitude = mean(deploy_latitude, na.rm = T),
                   deploy_longitude = mean(deploy_longitude, na.rm = T)
                   # ,deploy_latitude2 = median(deploy_latitude),
                   # deploy_longitude2 = median(deploy_longitude)
                   )

## receiver_stations mean lat and lon
station_names_location <- deployments_BE_all %>%
  dplyr::group_by(station_name) %>%
  dplyr::summarise(deploy_latitude = mean(deploy_latitude, na.rm = T),
                   deploy_longitude = mean(deploy_longitude, na.rm = T)) %>%
  tidyr::drop_na()

# check mean location of deployments
# leaflet() %>%
#   addTiles() %>%
#   addCircleMarkers(data = acoustic_projects_location,
#                    lat = ~deploy_latitude,
#                    lng = ~deploy_longitude,
#                    popup = ~paste0("acoustic project: ", acoustic_project_code))

## 3. maintained acoustic receivers

receivers_maintained <- deployments_BE_all %>%
  dplyr::group_by(deploy_year, acoustic_project_code) %>%
  dplyr::summarise(n = dplyr::n()) %>%
  tidyr::pivot_wider(names_from = acoustic_project_code,
                     values_from = n) %>%
  replace(is.na(.), 0) %>%
  dplyr::mutate(total = rowSums(across())) %>%
  dplyr::relocate(deploy_year, total, bpns, ws1, ws2, ws3, zeeschelde, bovenschelde)

receivers_maintained_long <- deployments_BE_all %>%
  dplyr::group_by(deploy_year, acoustic_project_code) %>%
  dplyr::summarise(n = dplyr::n()) %>%
  dplyr::left_join(acoustic_projects_location, by = "acoustic_project_code") %>%
  dplyr::mutate(deploy_year = deploy_year %>% factor()) 

receivers_maintained_station <- deployments_BE_all %>%
  dplyr::group_by(deploy_year, station_name) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::left_join(station_names_location, by = "station_name")

## 4. lost acoustic receivers (from the acoustic deployments above)

last_deployment_per_receiver <- deployments_BE_all %>% 
  dplyr::group_by(receiver_id) %>%
  dplyr::summarise(deploy_date_time = max(deploy_date_time),
                   deployment_id = deployment_id[which.max(deploy_date_time)]) %>% #get the last deploy_date_time 
  left_join(deployments_BE_all %>%
              dplyr::select(deployment_id, station_name, receiver_id, acoustic_project_code, recover_date_time, station_manager, deploy_latitude, deploy_longitude, battery_installation_date, comments), # get remaining columns
            by = c('deployment_id', 'receiver_id'))

receivers_lost <- etn::get_acoustic_receivers(status = "lost") %>%
  dplyr::left_join(last_deployment_per_receiver, by = "receiver_id") %>%
  dplyr::mutate(year = deploy_date_time %>% lubridate::year()) %>%
  dplyr::select(!c(financing_project:ar_tilt_after_deploy))

receivers_lost_overview <- receivers_lost %>%
  dplyr::group_by(year, acoustic_project_code) %>%
  dplyr::summarise(n = dplyr::n()) %>%
  tidyr::pivot_wider(names_from = acoustic_project_code,
                     values_from = n) %>%
  replace(is.na(.), 0) %>%
  dplyr::mutate(year = ifelse(year == 0, NA, year),
                total = rowSums(across())) %>%
  dplyr::relocate(year, total, bpns, ws1, ws2, ws3, zeeschelde, bovenschelde)

receivers_lost_overview_long <- receivers_lost %>%
  dplyr::group_by(year, acoustic_project_code) %>%
  dplyr::summarise(n = dplyr::n()) %>%
  dplyr::mutate(year = year %>% factor()) %>%
  dplyr::filter(!is.na(year)) %>%
  dplyr::left_join(acoustic_projects_location, by = "acoustic_project_code")


```

```{r otherqueries, include=F}
# EEZs
# Dutch_EEZ <-  mregions2::gaz_search(5668) %>% mregions2::gaz_geometry()
BPNS <- mregions2::gaz_search(3293) %>% mregions2::gaz_geometry()
# French_EEZ <- mregions2::gaz_search(5677) %>% mregions2::gaz_geometry()
# UK_EEZ <- mregions2::gaz_search(5696) %>% mregions2::gaz_geometry()

# EEZs <- rbind(Dutch_EEZ, BPNS, French_EEZ, UK_EEZ)
```

```{r mapprerequisites, include=FALSE}

# MAP PREREQUISITES
## North Arrow
north.arrow.icon <-
  "<img src='https://www.clipartbest.com/cliparts/yTo/Lgr/yToLgryGc.png' style='width:40px;height:50px;'>"

## EMODnet Bathymetry layer
emodnet_tiles <-"https://tiles.emodnet-bathymetry.eu/2020/baselayer/web_mercator/{z}/{x}/{y}.png"
cite_emodnet <- "<a href='https://emodnet.ec.europa.eu'>EMODnet</a>"
attr(cite_emodnet, "class") <- c("html", "character")

## colour palette
# col_fun <- scico::scico(n = deployments_BE_all$deploy_year %>% unique() %>% length(),
#                         palette = "managua")

palette_colorgorical <- c("#399283", "#b54164", "#b6eee2", "#866163", "#5cf070", "#fe7dda", "#83aa3e", "#6153a0", "#d3ee80", "#9844bf", "#3cfdd7", "#bf3e15", "#1aa7ee")


pal <- leaflet::colorFactor(palette_colorgorical, domain = deployments_BE_all$deploy_year)


```


The following acoustic projects are considered at the moment: `r acoustic_projects_location$acoustic_project_code %>% unique()`.

# 1. Maintained receivers

<!-- Some receiver deployments from the `r receivers_maintained_long %>% dplyr::ungroup() %>% dplyr::filter(deploy_year == 2025) %>% dplyr::select(acoustic_project_code) %>% pull()` acoustic project have deployment years of 2025. Those are listed in the following (tab '2025'). -->

## Overview {.tabset}

### Plot

```{r maintainedreceiversplot}

p_maintained_receivers <- ggplot(receivers_maintained_long) +
  geom_bar(aes(x = deploy_year, y = n, fill = acoustic_project_code),
           position = position_stack(), stat = "identity") +
  scico::scale_fill_scico_d(palette = "roma") +
  scale_y_continuous(expand = c(0,0)) +
  # scale_x_datetime(breaks = "1 year") +
  theme_bw() +
  labs(y = "# of receivers maintained", x = "year of receiver deployment", fill = "acoustic project code")

p_maintained_receivers

```

<!-- ### Map -->

<!-- ```{r maintainedreceiversoverviewmap} -->

<!-- # MAP -->
<!-- leaflet() %>% -->
<!--   setView(3.3, 51.55, zoom = 8) %>% -->
<!--   addProviderTiles(providers$CartoDB.Positron) %>% -->
<!-- # EEZ -->
<!--   addPolygons(data = BPNS, color = "grey", weight = 2, fillOpacity = 0.15, group = "receiver areas") %>% -->
<!--   # lost receivers by year -->

<!--   ## overview -->
<!--   addCircleMarkers(data = receivers_maintained_long, -->
<!--              lng = ~deploy_longitude, -->
<!--              lat = ~deploy_latitude, -->
<!--              weight = 1, -->
<!--              fillOpacity = 1, -->
<!--              radius = ~n / 5, -->
<!--              color = "black", -->
<!--              fillColor = ~pal(deploy_year), -->
<!--              popup = ~paste("<b># receivers maintained:</b> ", n, "<br>", -->
<!--                            # "<b>Owner:</b> ",owner_organization, "<br>", -->
<!--                            "<b>Year of deployments:</b> ", deploy_year, -->
<!--                            "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code), -->
<!--                            # "<br>", "<b>Station:</b> ", station_name), -->
<!--              group = "") %>% #label = ~paste(comments) -->

<!--   # add-ons -->
<!--   leaflet.extras::addFullscreenControl() %>% -->
<!--   leafem::addMouseCoordinates() %>% -->
<!--   addScaleBar(position = "bottomleft", -->
<!--               options = scaleBarOptions( -->
<!--                 maxWidth = 150, -->
<!--               imperial = FALSE)) %>% -->
<!--   addControl( html = north.arrow.icon, -->
<!--               position = "bottomleft", -->
<!--               className = "fieldset {border: 0;}") #%>% -->

<!-- ## layers control -->
<!-- # addLayersControl(position = "topright" , -->
<!-- #                  # baseGroups = c("OpenStreetMap", "EMODnet bathymetry", "satellite"), -->
<!-- #                  overlayGroups = c("2011", "2012", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022", "2023"), # "receiver stations", -->
<!-- #                  options = layersControlOptions(collapsed = FALSE)) %>% -->
<!-- # hideGroup(c("2011", "2012", "2014", "2015", "2016", "2017", "2018", "2019")) -->

<!-- ``` -->


### Table

```{r maintainedreceiversoverviewtable}

DT::datatable(receivers_maintained,
              rownames = F,
              filter = 'bottom',
              extension = 'Buttons',
              options = list(
                pageLength = 15,
                dom = 'Bfrtip',
                buttons = c('pdf', 'csv', 'excel', 'print','copy'),
                columnDefs = list(list(className = 'dt-center', targets = '_all'))
              )
            )

```

<!-- ### 2025 -->

<!-- ```{r maintainedreceivers2025table} -->

<!-- DT::datatable(deployments_BE_all %>% -->
<!--                 dplyr::filter(deploy_year == 2025) %>% -->
<!--                 dplyr::select(!valid_data_until_date_time:log_depth_sample_period), -->
<!--               rownames = F, -->
<!--               filter = 'bottom', -->
<!--               extension = 'Buttons', -->
<!--               options = list( -->
<!--                 pageLength = 15, -->
<!--                 dom = 'Bfrtip', -->
<!--                 buttons = c('pdf', 'csv', 'excel', 'print','copy'), -->
<!--                 columnDefs = list(list(className = 'dt-center', targets = '_all')) -->
<!--               ) -->
<!--             ) -->

<!-- ``` -->

## Map

<!-- maybe overview per receiver station? -->

```{r maintainedreceiversmap, message = FALSE, echo = FALSE}

leaflet() %>%
  setView(3.3, 51.296, zoom = 8) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
# EEZ
  addPolygons(data = BPNS, color = "grey", weight = 2, fillOpacity = 0.15, group = "receiver areas") %>%
  # lost receivers by year
  
  ## 2011
  addCircleMarkers(data = receivers_maintained_long,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(deploy_year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2011") %>% #label = ~paste(comments)
    
    ## 2012
    addCircleMarkers(data = receivers_maintained_long 
                    %>% dplyr::filter(year == 2012)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2012") %>% #label = ~paste(comments)
  
  ## 2014
    addCircleMarkers(data = receivers_maintained_long 
                    %>% dplyr::filter(year == 2014)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2014") %>% #label = ~paste(comments)
  
  ## 2015
    addCircleMarkers(data = receivers_maintained_long 
                    %>% dplyr::filter(year == 2015)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2015") %>% #label = ~paste(comments)
  
  ## 2016
    addCircleMarkers(data = receivers_maintained_long 
                    %>% dplyr::filter(year == 2016)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2016") %>% #label = ~paste(comments)
  
  ## 2017
    addCircleMarkers(data = receivers_maintained_long 
                    %>% dplyr::filter(year == 2017)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2017") %>% #label = ~paste(comments)
  
  ## 2018
    addCircleMarkers(data = receivers_maintained_long 
                    %>% dplyr::filter(year == 2018)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2018") %>% #label = ~paste(comments)
  
 ## 2019
    addCircleMarkers(data = receivers_maintained_long 
                    %>% dplyr::filter(year == 2019)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2019") %>% #label = ~paste(comments)
  
  ## 2020
    addCircleMarkers(data = receivers_maintained_long 
                    %>% dplyr::filter(year == 2020)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2020") %>% #label = ~paste(comments)
  
  ## 2021
    addCircleMarkers(data = receivers_maintained_long 
                    %>% dplyr::filter(year == 2021)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2021") %>% #label = ~paste(comments)
  
  ## 2022
    addCircleMarkers(data = receivers_maintained_long 
                    %>% dplyr::filter(year == 2022)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2022") %>% #label = ~paste(comments)
  
  ## 2023
    addCircleMarkers(data = receivers_maintained_long 
                    %>% dplyr::filter(year == 2023)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2023") %>% #label = ~paste(comments)
  
  # add-ons
  leaflet.extras::addFullscreenControl() %>%
  leafem::addMouseCoordinates() %>%
  addScaleBar(position = "bottomleft",
              options = scaleBarOptions(
                maxWidth = 150,
              imperial = FALSE)) %>%
  addControl( html = north.arrow.icon,
              position = "bottomleft",
              className = "fieldset {border: 0;}") %>%

# layers control
addLayersControl(position = "topright" ,
                 overlayGroups = c("2011", "2012", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022", "2023"), # "receiver stations",
                 options = layersControlOptions(collapsed = FALSE)) %>%
hideGroup(c("2011", "2012", "2014", "2015", "2016", "2017", "2018", "2019"))

```


# 2. Lost receivers

## Overview {.tabset}

The lost receivers without a `deploy_date_time` or an `acoustic_project_code` (n = `r receivers_lost %>% dplyr::filter(is.na(year) & is.na(acoustic_project_code)) %>% nrow()`) are excluded from the barplot.

### Plot

```{r lostreceiversbarplot}

p_lost_receivers <- ggplot(receivers_lost_overview_long) +
  geom_bar(aes(x = year, y = n, fill = acoustic_project_code),
           position = position_stack(), stat = "identity") +
  scico::scale_fill_scico_d(palette = "roma") +
  scale_y_continuous(expand = c(0,0)) +
  # scale_x_datetime(breaks = "1 year") +
  theme_bw() +
  labs(y = "# of receivers lost", x = "year", fill = "acoustic project code")

p_lost_receivers
```

### Table

```{r lostreceiversoverviewtable}

DT::datatable(receivers_lost_overview,
              rownames = F,
              filter = 'bottom',
              extension = 'Buttons',
              options = list(
                pageLength = 15,
                dom = 'Bfrtip',
                buttons = c('pdf', 'csv', 'excel', 'print','copy'),
                columnDefs = list(list(className = 'dt-center', targets = '_all'))
              )
            )
```


## Map

```{r map, message = FALSE, echo = FALSE}
# MAP PREREQUISITES

## North Arrow
north.arrow.icon <-
  "<img src='https://www.clipartbest.com/cliparts/yTo/Lgr/yToLgryGc.png' style='width:40px;height:50px;'>"

## EMODnet Bathymetry layer
emodnet_tiles <-"https://tiles.emodnet-bathymetry.eu/2020/baselayer/web_mercator/{z}/{x}/{y}.png"
cite_emodnet <- "<a href='https://emodnet.ec.europa.eu'>EMODnet</a>"
attr(cite_emodnet, "class") <- c("html", "character")

## colour palette
col_fun <- scico::scico(n = receivers_lost$year %>% unique() %>% length(),
                        palette = "managua")

palette_colorgorical <- c("#399283", "#b54164", "#b6eee2", "#866163", "#5cf070", "#fe7dda", "#83aa3e", "#6153a0", "#d3ee80", "#9844bf", "#3cfdd7", "#bf3e15", "#1aa7ee")
  
  # 
  # c("#4f8c9d", "#bc0542", "#11e38c", "#6d1f27", "#72df19", "#521691", "#c0dea4", "#052b25", "#cad3fa", "#010840", "#54d7eb", "#b55d57", "#056e12")
  # 
  # c("#68affc", "#2e0c37", "#a9e81a", "#e0079b", "#539322", "#ab5cf6", "#d5fdb6", "#1607a3", "#f1e736", "#133346", "#faa38c", "#5054b1", "#fb7810")

pal <- leaflet::colorFactor(palette_colorgorical, domain = receivers_lost$year)

# col_fun_apc <- scico::scico(n = receivers_lost$acoustic_project_code %>% unique() %>% length(),
#                         palette = "managua")
# pal_apc <- leaflet::colorFactor(col_fun, domain = receivers_lost$acoustic_project_code)

# MAP
m2 <- leaflet() %>%
  setView(3.3, 51.296, zoom = 8) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
# EEZ
  addPolygons(data = BPNS, color = "grey", weight = 2, fillOpacity = 0.15, group = "receiver areas") %>%
  # lost receivers by year
  
  ## 2011
  addCircleMarkers(data = receivers_lost %>% tidyr::drop_na(deploy_date_time) 
                    %>% dplyr::filter(year == 2011)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2011") %>% #label = ~paste(comments)
    
    ## 2012
    addCircleMarkers(data = receivers_lost %>% tidyr::drop_na(deploy_date_time) 
                    %>% dplyr::filter(year == 2012)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2012") %>% #label = ~paste(comments)
  
  ## 2014
    addCircleMarkers(data = receivers_lost %>% tidyr::drop_na(deploy_date_time) 
                    %>% dplyr::filter(year == 2014)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2014") %>% #label = ~paste(comments)
  
  ## 2015
    addCircleMarkers(data = receivers_lost %>% tidyr::drop_na(deploy_date_time) 
                    %>% dplyr::filter(year == 2015)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2015") %>% #label = ~paste(comments)
  
  ## 2016
    addCircleMarkers(data = receivers_lost %>% tidyr::drop_na(deploy_date_time) 
                    %>% dplyr::filter(year == 2016)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2016") %>% #label = ~paste(comments)
  
  ## 2017
    addCircleMarkers(data = receivers_lost %>% tidyr::drop_na(deploy_date_time) 
                    %>% dplyr::filter(year == 2017)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2017") %>% #label = ~paste(comments)
  
  ## 2018
    addCircleMarkers(data = receivers_lost %>% tidyr::drop_na(deploy_date_time) 
                    %>% dplyr::filter(year == 2018)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2018") %>% #label = ~paste(comments)
  
 ## 2019
    addCircleMarkers(data = receivers_lost %>% tidyr::drop_na(deploy_date_time) 
                    %>% dplyr::filter(year == 2019)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2019") %>% #label = ~paste(comments)
  
  ## 2020
    addCircleMarkers(data = receivers_lost %>% tidyr::drop_na(deploy_date_time) 
                    %>% dplyr::filter(year == 2020)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2020") %>% #label = ~paste(comments)
  
  ## 2021
    addCircleMarkers(data = receivers_lost %>% tidyr::drop_na(deploy_date_time) 
                    %>% dplyr::filter(year == 2021)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2021") %>% #label = ~paste(comments)
  
  ## 2022
    addCircleMarkers(data = receivers_lost %>% tidyr::drop_na(deploy_date_time) 
                    %>% dplyr::filter(year == 2022)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2022") %>% #label = ~paste(comments)
  
  ## 2023
    addCircleMarkers(data = receivers_lost %>% tidyr::drop_na(deploy_date_time) 
                    %>% dplyr::filter(year == 2023)
                   ,
             lng = ~deploy_longitude, 
             lat = ~deploy_latitude, 
             weight = 1,
             fillOpacity = 1,
             radius = 7,
             color = "black",
             fillColor = ~pal(year),
             popup = ~paste("<b>Receiver:</b> ", receiver_id, "<br>", 
                           "<b>Owner:</b> ",owner_organization, "<br>",
                           "<b>Year lost:</b> ", year, 
                           "<br>", "<b>Ac. proj. code:</b> ", acoustic_project_code,
                           "<br>", "<b>Station:</b> ", station_name),
             group = "2023") %>% #label = ~paste(comments)
  
  # add-ons
  leaflet.extras::addFullscreenControl() %>%
  leafem::addMouseCoordinates() %>%
  addScaleBar(position = "bottomleft",
              options = scaleBarOptions(
                maxWidth = 150,
              imperial = FALSE)) %>%
  addControl( html = north.arrow.icon,
              position = "bottomleft",
              className = "fieldset {border: 0;}") %>%

# layers control
addLayersControl(position = "topright" ,
                 # baseGroups = c("OpenStreetMap", "EMODnet bathymetry", "satellite"),
                 overlayGroups = c("2011", "2012", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022", "2023"), # "receiver stations",
                 options = layersControlOptions(collapsed = FALSE)) %>%
hideGroup(c("2011", "2012", "2014", "2015", "2016", "2017", "2018", "2019"))

m2

```


## Lost receivers per year {.tabset}


<!-- - Details of the receivers lost since 2019 are displayed in the following (*can be extended to earlier years, too, of course*). -->

- Many receivers don't have a `deploy_date_time` and/or a `acoustic_project_code`. Those are listed in the tab **NA**.


```{r tablegeneration, results='asis', include=FALSE}

unique_years <- distinct(receivers_lost, year)$year

generate_table_for_year <- function(year) {
  # df <- receivers_lost %>% filter(year == year)
  table_id <- glue::glue("tablelostreceivers-{year}")
  
  content <- glue::glue(
    "### {year}\n\n",
    # "```\n",
    "```{{r {table_id}}}\n\n",
    "DT::datatable(receivers_lost %>% filter(year == {year}),\n",
    "  rownames = F,\n",
    "  filter = 'bottom',\n",
    "  extension = 'Buttons',\n",
    "  options = list(\n",
    "    pageLength = 15,\n",
    "    dom = 'Bfrtip',\n",
    "    buttons = c('pdf', 'csv', 'excel', 'print','copy'),\n",
    "    columnDefs = list(list(className = 'dt-center', targets = '_all'))))\n\n",
    # "  )\n\n",
    # "{year}\n\n",
    # "```\n",
    "```\n\n\n"
  )
  
  return(content)
}

# walk(unique_years, ~cat(generate_table_for_year(.x)))
```

### 2011

```{r tablelostreceivers-2011}

DT::datatable(receivers_lost %>% filter(year == 2011),
  rownames = F,
  filter = 'bottom',
  extension = 'Buttons',
  options = list(
    pageLength = 15,
    dom = 'Bfrtip',
    buttons = c('pdf', 'csv', 'excel', 'print','copy'),
    columnDefs = list(list(className = 'dt-center', targets = '_all'))))

```

### 2012

```{r tablelostreceivers-2012}

DT::datatable(receivers_lost %>% filter(year == 2012),
  rownames = F,
  filter = 'bottom',
  extension = 'Buttons',
  options = list(
    pageLength = 15,
    dom = 'Bfrtip',
    buttons = c('pdf', 'csv', 'excel', 'print','copy'),
    columnDefs = list(list(className = 'dt-center', targets = '_all'))))

```


### 2014

```{r tablelostreceivers-2014}

DT::datatable(receivers_lost %>% filter(year == 2014),
  rownames = F,
  filter = 'bottom',
  extension = 'Buttons',
  options = list(
    pageLength = 15,
    dom = 'Bfrtip',
    buttons = c('pdf', 'csv', 'excel', 'print','copy'),
    columnDefs = list(list(className = 'dt-center', targets = '_all'))))

```

### 2015

```{r tablelostreceivers-2015}

DT::datatable(receivers_lost %>% filter(year == 2015),
  rownames = F,
  filter = 'bottom',
  extension = 'Buttons',
  options = list(
    pageLength = 15,
    dom = 'Bfrtip',
    buttons = c('pdf', 'csv', 'excel', 'print','copy'),
    columnDefs = list(list(className = 'dt-center', targets = '_all'))))

```


### 2016

```{r tablelostreceivers-2016}

DT::datatable(receivers_lost %>% filter(year == 2016),
  rownames = F,
  filter = 'bottom',
  extension = 'Buttons',
  options = list(
    pageLength = 15,
    dom = 'Bfrtip',
    buttons = c('pdf', 'csv', 'excel', 'print','copy'),
    columnDefs = list(list(className = 'dt-center', targets = '_all'))))

```

### 2017

```{r tablelostreceivers-2017}

DT::datatable(receivers_lost %>% filter(year == 2017),
  rownames = F,
  filter = 'bottom',
  extension = 'Buttons',
  options = list(
    pageLength = 15,
    dom = 'Bfrtip',
    buttons = c('pdf', 'csv', 'excel', 'print','copy'),
    columnDefs = list(list(className = 'dt-center', targets = '_all'))))

```

### 2018

```{r tablelostreceivers-2018}

DT::datatable(receivers_lost %>% filter(year == 2018),
  rownames = F,
  filter = 'bottom',
  extension = 'Buttons',
  options = list(
    pageLength = 15,
    dom = 'Bfrtip',
    buttons = c('pdf', 'csv', 'excel', 'print','copy'),
    columnDefs = list(list(className = 'dt-center', targets = '_all'))))

```

### 2019

```{r tablelostreceivers-2019}

DT::datatable(receivers_lost %>% filter(year == 2019),
  rownames = F,
  filter = 'bottom',
  extension = 'Buttons',
  options = list(
    pageLength = 15,
    dom = 'Bfrtip',
    buttons = c('pdf', 'csv', 'excel', 'print','copy'),
    columnDefs = list(list(className = 'dt-center', targets = '_all'))))

```

### 2020

```{r tablelostreceivers-2020}

DT::datatable(receivers_lost %>% filter(year == 2020),
  rownames = F,
  filter = 'bottom',
  extension = 'Buttons',
  options = list(
    pageLength = 15,
    dom = 'Bfrtip',
    buttons = c('pdf', 'csv', 'excel', 'print','copy'),
    columnDefs = list(list(className = 'dt-center', targets = '_all'))))

```

### 2021

```{r tablelostreceivers-2021}

DT::datatable(receivers_lost %>% filter(year == 2021),
  rownames = F,
  filter = 'bottom',
  extension = 'Buttons',
  options = list(
    pageLength = 15,
    dom = 'Bfrtip',
    buttons = c('pdf', 'csv', 'excel', 'print','copy'),
    columnDefs = list(list(className = 'dt-center', targets = '_all'))))

```

### 2022

```{r tablelostreceivers-2022}

DT::datatable(receivers_lost %>% filter(year == 2022),
  rownames = F,
  filter = 'bottom',
  extension = 'Buttons',
  options = list(
    pageLength = 15,
    dom = 'Bfrtip',
    buttons = c('pdf', 'csv', 'excel', 'print','copy'),
    columnDefs = list(list(className = 'dt-center', targets = '_all'))))

```

### 2023

```{r tablelostreceivers-2023}

DT::datatable(receivers_lost %>% filter(year == 2023),
  rownames = F,
  filter = 'bottom',
  extension = 'Buttons',
  options = list(
    pageLength = 15,
    dom = 'Bfrtip',
    buttons = c('pdf', 'csv', 'excel', 'print','copy'),
    columnDefs = list(list(className = 'dt-center', targets = '_all'))))

```


### NA

```{r tablelostreceivers-NA}

DT::datatable(receivers_lost %>% filter(year %>% is.na()),
  rownames = F,
  filter = 'bottom',
  extension = 'Buttons',
  options = list(
    pageLength = 15,
    dom = 'Bfrtip',
    buttons = c('pdf', 'csv', 'excel', 'print','copy'),
    columnDefs = list(list(className = 'dt-center', targets = '_all'))))

```


